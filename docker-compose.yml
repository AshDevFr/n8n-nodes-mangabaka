services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    ports:
      - "5678:5678"
    volumes:
      - n8n-data:/home/node/.n8n
      - ./dist:/home/node/.n8n/custom/n8n-nodes-mangabaka
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=admin
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=UTC
    restart: unless-stopped
    depends_on:
      build:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    develop:
      watch:
        - action: restart
          path: ./dist

  build:
    image: node:22-alpine
    container_name: mangabaka-node-builder
    working_dir: /workspace
    volumes:
      - .:/workspace
      - node_modules:/workspace/node_modules
    command: >
      sh -c "
        echo 'Installing dependencies...' &&
        npm install &&
        echo 'Building initial version...' &&
        npm run build &&
        echo 'Starting watch mode...' &&
        npm run build:watch
      "
    restart: unless-stopped
    develop:
      watch:
        - action: sync+restart
          path: ./nodes
          target: /workspace/nodes
        - action: sync+restart
          path: ./credentials
          target: /workspace/credentials
        - action: sync+restart
          path: ./package.json
          target: /workspace/package.json
        - action: sync+restart
          path: ./tsconfig.json
          target: /workspace/tsconfig.json

  debug-server:
    image: node:22-alpine
    container_name: mangabaka-debug-server
    working_dir: /app
    volumes:
      - ./debug-server.js:/app/debug-server.js
    command: node debug-server.js
    ports:
      - "3000:3000"
    restart: unless-stopped

volumes:
  n8n-data:
  node_modules:

